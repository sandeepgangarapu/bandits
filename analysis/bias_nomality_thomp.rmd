---
title: "Bias and Normality of Thompson Sampling based algorithms"
author: "Sandeep Gangarapu"
output: html_document
---
  
Concusions:

Mean estimates of MAB and AB behave as intended for both Best and Worst arms.

* Best arm estimates for Thompson IPW and AIPW are *biased* for some reason
* Worst arm estimates for Thompson IPW and AIPW are unbiased do not follow normality. This means IPW and AIPW will only correct the bias bunt not normality.


**We are sampling from 2 arms with distributions of N(2,1) - the worst arm and N(3,1) the best arm.**
  
```{r echo=FALSE, warning=FALSE}
suppressPackageStartupMessages(
  {
    library(ggplot2)
    library(dplyr)
    library(tidyr)
    library(rcompanion)
  })
```


```{r echo=FALSE, warning=FALSE}

setwd("G:\\My Drive\\Research\\Bandits\\code\\bandits\\analysis\\output")

true_means = c(2,3)

true_vars = c(1,1)

true_means = c(1.5,2.8,3)

true_vars = c(1,1,1)


grp = c(0:(length(true_means)-1))
true_df <- data.frame(grp, true_means, true_vars)
true_df <- true_df %>% mutate(grp=factor(grp))

seed_algs <- c("ab", "ucb", "thomp", "eps_greedy")
inf_algs <- c("ucb_inf_eps", "thomp_inf_eps")
est_algs <- c("thomp_ipw", "thomp_aipw", "thomp_inf_eps_ipw",
              "thomp_inf_eps_aipw", "thomp_eval_aipw", 'thomp_inf_eps_eval_aipw',
              "ucb_aipw", "ucb_ipw",  "ucb_inf_eps_aipw", "ucb_inf_eps_ipw" )
thomp_algs <- c( "thomp", "thomp_inf_eps")
thomp_est_algs <- c( "thomp_ipw", "thomp_aipw", "thomp_eval_aipw", "thomp_inf_eps_ipw",
                     "thomp_inf_eps_aipw", 'thomp_inf_eps_eval_aipw')
ucb_algs <- c("ucb_inf_eps", "ucb")
ucb_est_algs <- c("ucb_aipw", "ucb_ipw",  "ucb_inf_eps_aipw", "ucb_inf_eps_ipw")
adv_algs <- c(thomp_algs, ucb_algs)
# data <- read.csv("bias_500_50.csv")
# data <- read.csv("bias_500_200.csv")
data <- read.csv("res_10_500.csv")

group_outcome <- data  %>%  filter(alg %in% c(seed_algs, inf_algs)) %>%
  select(alg, group, ite, outcome) %>%
  group_by(ite,alg) %>% mutate(x=row_number()) %>%
  ungroup()
means <- group_outcome  %>% group_by(group, alg, ite) %>%
  summarise(mn = mean(outcome)) %>% ungroup()


weighed_means <- data %>%  filter(alg %in% est_algs) %>%
  select(alg, ite, group, mean_est) %>% 
  group_by(ite,alg, group) %>%
  mutate(x=row_number(), y= max(row_number())) %>%
  ungroup() %>% filter(x==y) %>% select(-c(x,y)) %>% rename(mn = mean_est)

```


# Bias

We expect sample mean estimate of *best* arm for MAB algorithms to be unbiased and drawn from Normal distribution

We expect sample mean estimate of *worst* arm for MAB algorithms to be biased and not drawn from Normal distribution

We expect sample mean estimate of *worst* arm for *AB* to be unbiased and drawn from Normal distribution

```{r echo=FALSE, warning=FALSE}

best <- means %>% filter(group==which.max(true_means)-1) %>%
  filter (alg %in% c('ab', 'thomp', 'thomp_inf_eps')) %>% 
  mutate(bias = mn-max(true_means)) %>% group_by(alg) %>%
  summarise(Bias = mean(bias), se = sd(bias)/sqrt(n()))

ylimit <- 0.3

ggplot(best, aes(x=reorder(alg, abs(Bias)), y=Bias)) + geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=Bias-qnorm(0.975)*se, ymax=Bias+qnorm(0.975)*se), width=0.2) +
  theme_bw()  + ylim(-ylimit, ylimit) + theme(axis.title.x=element_blank()) +
  geom_hline(yintercept = 0) + 
  #labs(title = "Bias of Best arm") +
  theme(axis.text.x = element_text(angle = 90)) +
  ggsave("bias_best.png", width = 8, height = 2, dpi=300, units="in")

```



```{r echo=FALSE, warning=FALSE}

worst <- means %>% filter(group==which.min(true_means)-1) %>% 
  filter (alg %in% c('ab', 'thomp', 'thomp_inf_eps')) %>% 
  mutate(bias = mn-min(true_means)) %>% group_by(alg) %>%
  summarise(Bias = mean(bias), se = sd(bias)/sqrt(n()))

ylimit <- 0.8
ggplot(worst, aes(x=reorder(alg, abs(Bias)), y=Bias)) + geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=Bias-qnorm(0.975)*se, ymax=Bias+qnorm(0.975)*se), width=0.2) +
  theme_bw()  + ylim(-ylimit, ylimit) + theme(axis.title.x=element_blank()) +
  geom_hline(yintercept = 0) + labs(title = "Bias of Worst arm") + theme(axis.text.x = element_text(angle = 90)) 


```

This is as expected. Thompson sampling, a MAB algorithms has a negative bias for its sample mean estimate of the worst arm.


# Normality

We Expect 

* AB Testing - Best - Normal
* AB Testing - Worst - Normal


* Thompson Sampling - Best - Normal
* Thompson Sampling - Worst - Not Normal

The null hypothesis states that it follows Normal Distribution

## AB Testing

```{r echo=FALSE, warning=FALSE}

best_ab <- copy(agg_data)[group==which.max(true_means)-1 & alg=='ab']

plotNormalHistogram(best_ab$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - AB")
abline(v=3,  col="red")

shapiro.test(best_ab$mn)

worst_ab <- copy(agg_data)[group==which.min(true_means)-1 & alg=='ab']

plotNormalHistogram(worst_ab$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - AB",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_ab$mn)


```

## Thompson Sampling

```{r echo=FALSE, warning=FALSE}

best_thomp <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp']

plotNormalHistogram(best_thomp$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMP")
abline(v=3,  col="red")

shapiro.test(best_thomp$mn)

worst_thomp <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp']

plotNormalHistogram(worst_thomp$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMP",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_thomp$mn)
```

```{r echo=FALSE, warning=FALSE}

best_thomp_ipw <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_ipw']

plotNormalHistogram(best_thomp_ipw$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMPIPW")
abline(v=3,  col="red")

shapiro.test(best_thomp_ipw$mn)

worst_thomp_ipw <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_ipw']

plotNormalHistogram(worst_thomp_ipw$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMPIPW",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_thomp_ipw$mn)
```

```{r echo=FALSE, warning=FALSE}

best_thomp_eval_aipw <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_eval_aipw']

plotNormalHistogram(best_thomp_eval_aipw$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMP")
abline(v=3,  col="red")

shapiro.test(best_thomp_eval_aipw$mn)

worst_thomp_eval_aipw <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_eval_aipw']

plotNormalHistogram(worst_thomp_eval_aipw$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMP",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_thomp_eval_aipw$mn)
```


## Thompson Sampling INF

```{r echo=FALSE, warning=FALSE}

best_thomp_inf <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_inf']

plotNormalHistogram(best_thomp_inf$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMP")
abline(v=3,  col="red")

shapiro.test(best_thomp_inf$mn)

worst_thomp_inf <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_inf']

plotNormalHistogram(worst_thomp_inf$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMP",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_thomp_inf$mn)
```

```{r echo=FALSE, warning=FALSE}

best_thomp_inf_ipw <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_inf_ipw']

plotNormalHistogram(best_thomp_inf_ipw$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMPIPW")
abline(v=3,  col="red")

shapiro.test(best_thomp_inf_ipw$mn)

worst_thomp_inf_ipw <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_inf_ipw']

plotNormalHistogram(worst_thomp_inf_ipw$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMPIPW",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_thomp_inf_ipw$mn)
```

```{r echo=FALSE, warning=FALSE}

best_thomp_inf_eval_aipw <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_inf_eval_aipw']

plotNormalHistogram(best_thomp_inf_eval_aipw$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMP")
abline(v=3,  col="red")

shapiro.test(best_thomp_inf_eval_aipw$mn)

worst_thomp_inf_eval_aipw <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_inf_eval_aipw']

plotNormalHistogram(worst_thomp_inf_eval_aipw$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMP",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_thomp_inf_eval_aipw$mn)
```