---
title: "Main MAB simulations"
author: "Sandeep Gangarapu"
output: html_document
---
  
# Load the libraries

```{r echo=FALSE, warning=FALSE}
suppressPackageStartupMessages(
  {
    library(ggplot2)
    library(data.table)
    require(gridExtra)
    require(directlabels)
    require(rcompanion)
    library(dplyr)
  })
```

# Setting global variables


```{r echo=FALSE, cache=FALSE, warning=FALSE}


# knobs for analysis
group_allocations<-TRUE
single_ite_reg <- TRUE
xi_analysis <- FALSE
reg_order_analysis <- TRUE

seed_algs <- c("ab", "thomp", "thomp_inf")
est_algs <- c("thomp_ipw", "thomp_aipw", "thomp_eval_aipw",
              "thomp_inf_ipw", "thomp_inf_aipw", "thomp_inf_eval_aipw")

#true_means <- c(0.25, 1.82, 1.48, 2.25, 2)
#true_vars = c(2.84, 1.97, 2.62, 1, 2.06)

#true_means <- c(1,1.5,2)
# 
# true_means <- c(1, 1.1, 1.2)
# true_vars <- c(1/3, 1/3, 1/3)



# Bernoulli _means and vars
# true_means <- c(0.157, 0.178, 0.199, 0.146, 0.129)
# true_vars = c (0.132351, 0.146316, 0.159399, 0.124684, 0.112359)

true_means <- c(0.37098621, 0.33080171, 0.1699615 , 0.18902466, 0.6743146)
true_means = c(0.4, 0.5, 0.6)
true_means = c(0.2, 0.5, 0.8)
true_vars = true_means**2


grp = c(0:(length(true_means)-1))
true_df <- data.frame(grp, true_means, true_vars)
true_df <- true_df %>% mutate(grp=factor(grp))


```

# Loading data

## Load non aggregate data data

```{r echo=FALSE, cache=FALSE, warning=FALSE}

setwd("G:\\My Drive\\Research\\Bandits\\code\\bandits\\analysis\\output")
non_agg_data <- fread("test_batched.csv")
# remove NA's
non_agg_data <- non_agg_data[complete.cases(non_agg_data),]
non_agg_data <- non_agg_data[, alg := ifelse(alg=="ab", "ABTesting", ifelse(alg=="thomp","THOMP", ifelse(alg=="thomp_inf", "THOMP_INF", ifelse(alg=="thomp_athey", "HADAD", ifelse(alg=="thomp_bern", "THOMP", ifelse(alg=="thomp_inf_bern", "THOMP_INF",ifelse(alg=="ab_bern", "AB", ifelse(alg=="thomp_athey_bern", "HADAD",ifelse(alg=="thomp_bern_batched", "THOMP_BATCHED", ifelse(alg=="thomp_inf_bern_batched", "THOMP_INF_BATCHED","NONE"))))))))))]

group_outcome <- copy(non_agg_data)[, x:= seq_len(.N),.(ite,alg)][, .(alg, group, x, ite)]
regret_mse <- copy(non_agg_data)[, x:= seq_len(.N),.(ite,alg)][, .(alg, regret, ite, mean_mse, var_mse, x)]

```

## Load aggregate data data

```{r echo=FALSE, cache=FALSE, warning=FALSE}

setwd("G:\\My Drive\\Research\\Bandits\\code\\bandits\\analysis\\output")
agg_data <- fread("hsn_bern_agg_batched.csv")
agg_data <- fread("agg_analysis_batched.csv")

agg_data <- agg_data[complete.cases(agg_data),][mean_est != -Inf | mean_est != Inf][, mn := mean_est]

```



# Group allocations


```{r echo=FALSE, cache=FALSE, warning=FALSE, eval=group_allocations}


xlimit <- max(group_outcome$x) + 500


df <- copy(group_outcome)[ite==5,] [x<2001]



grp <- ggplot(df %>% filter(alg!='HADAD')) + geom_point(aes(x=x, y=factor(group)), shape=1, alpha=0.6) +
  facet_grid(alg ~.) +
  labs(x='Time Period', y = 'Group') +
  theme(axis.text.y = element_text(size = rel(0.7)))  +  theme_bw() 
  ggsave("grp.png", dpi=400, height = 4, width=8, scale = 0.8)

grp
```






# Regret & MSE

## Single ITE analysis
```{r echo=FALSE, cache=FALSE, warning=FALSE, eval=single_ite_reg}

df_regret =  copy(regret_mse)[ite==0,] 


reg <- ggplot(df_regret, aes(x=x, y=regret)) + geom_line(aes(color=alg)) +
  xlim(0,12500) +
  geom_dl(aes(label=alg), method=list('last.points', cex=0.8)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'Regret') +
  ggsave("wise_reg.png", dpi=400, height = 4, width=8, scale = 0.8)

reg

df_mse <- copy(regret_mse)[, mse := mean_mse][, c('regret', 'var_mse', 'mean_mse'):=NULL][ite==0]


mn <- ggplot(df_mse, aes(x=x, y=mse)) + geom_line(aes(color=alg)) +
  xlim(0,10000) + ylim(0,0.005) +
  geom_dl(aes(label=alg), method=list('last.points', cex=0.8)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'MSE of Mean') 

# ggsave("wise_mn.png", dpi=400, height = 5, width=10, scale = 0.8)
mn

df_mse <- copy(regret_mse)[, mse := var_mse][, c('regret', 'var_mse', 'mean_mse'):=NULL][ite==0]



var <- ggplot(df_mse, aes(x=x, y=mse)) + geom_line(aes(color=alg)) +
  xlim(0,12500) + ylim(0,0.01) +
  geom_dl(aes(label=alg), method=list('last.points', cex=0.8)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'MSE of Variance') 

var 
# ggsave("wise_mn.png", dpi=400, height = 5, width=10, scale = 0.8)

# par(mfrow = c(1,2))
# 
# ggsave("wise_mn_var.png", arrangeGrob(mn, var, nrow = 1, ncol=2),
#        dpi=400, height = 4, width=10, scale = 0.8)


```







## Multiple ITE analysis
```{r echo=FALSE, cache=FALSE, warning=FALSE, eval=single_ite_reg}

df_regret = copy(regret_mse)[, .(regret = mean(regret), se = sd(regret)/sqrt(.N)),.(x, alg)]


reg <- ggplot(df_regret, aes(x=x, y=regret)) + geom_line(aes(color=alg)) +
  xlim(0,5500) + geom_ribbon(aes(ymin=regret-(1.96*se), ymax=regret+(1.96*se), group=alg), alpha=0.4,  fill="grey70") +
  geom_dl(aes(label=alg), method=list('last.points', cex=0.8)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'Regret') +
  ggsave("wise_reg.png", dpi=400, height = 4, width=8, scale = 0.8)

reg

df_mse <- copy(regret_mse)[, mse := mean_mse][, c('regret', 'var_mse', 'mean_mse'):=NULL][, .(mse = mean(mse), se = sd(mse)/sqrt(.N)),.(x, alg)]


mn <- ggplot(df_mse, aes(x=x, y=mse)) + geom_line(aes(color=alg)) +
  xlim(0,5500) + ylim(0,0.03) + geom_ribbon(aes(ymin=mse-(1.96*se), ymax=mse+(1.96*se), group=alg), alpha=0.4,  fill="grey70") +
  geom_dl(aes(label=alg), method=list('last.points', cex=0.8)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'MSE of Mean') + ggsave("wise_mn.png", dpi=400, height = 5, width=10, scale = 0.8)

mn

df_mse <- copy(regret_mse)[, mse := var_mse][, c('regret', 'var_mse', 'mean_mse'):=NULL][, .(mse = mean(mse), se = sd(mse)/sqrt(.N)),.(x, alg)]


var <- ggplot(df_mse, aes(x=x, y=mse)) + geom_line(aes(color=alg)) +
  xlim(0,5500) + ylim(0,0.03) + geom_ribbon(aes(ymin=mse-(1.96*se), ymax=mse+(1.96*se), group=alg), alpha=0.4,  fill="grey70") +
  geom_dl(aes(label=alg), method=list('last.points', cex=0.8)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'MSE of Variance') + ggsave("wise_var.png", dpi=400, height = 5, width=10, scale = 0.8)

var

# par(mfrow = c(1,2))
# 
# ggsave("wise_mn_var.png", arrangeGrob(mn, var, nrow = 1, ncol=2),
#        dpi=400, height = 4, width=10, scale = 0.8)


```








# Xi Analysis

```{r echo=FALSE, cache=FALSE, warning=FALSE, eval=xi_analysis}

setwd("G:\\My Drive\\Research\\Bandits\\code\\bandits\\analysis\\output")

xi = c(0.01, 0.05, 0.1, 0.15, 0.2, 0.5, 0.8, 1.1, 1.5)

main_xi_df <- data.frame()

for (i in xi){
  
  file_name = paste("xi_analysis", i, ".csv", sep="")
  df <- fread(file_name)
  df <- df[, xi:=i][, x := seq_len(.N), .(ite)]
  main_xi_df <- rbind(main_xi_df, df)
}

table(main_xi_df$xi)


# Setting new WD so that results are saved in different folder
setwd("G:\\My Drive\\Research\\Bandits\\code\\bandits\\analysis\\plots")

one_ite <- main_xi_df[alg=='thomp_inf_bern' & ite==0,]

ggplot(one_ite, aes(x=x, y=regret)) + geom_line(aes(colour=factor(xi))) +
  xlim(0,12000)+
  geom_dl(aes(label=xi), method=list('last.points', cex=0.5)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'Regret') 



```









# Multiple ite Xi Analysis

```{r echo=FALSE, cache=FALSE, warning=FALSE, eval=xi_analysis}




df_regret = copy(main_xi_df)[, .(regret = mean(regret), se = sd(regret)/sqrt(.N)),.(x ,xi)]


ggplot(df_regret, aes(x=x, y=regret)) + geom_line(aes(color=factor(xi))) +
  xlim(0,12000) + geom_ribbon(aes(ymin=regret-(1.96*se), ymax=regret+(1.96*se), group=xi), alpha=0.4,  fill="grey70") +
  geom_dl(aes(label=xi), method=list('last.points', cex=0.8)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'Regret') +
  ggsave("wise_reg.png", dpi=400, height = 4, width=8, scale = 0.8)



df_mse <- copy(main_xi_df)[, mse := mean_mse][, c('regret', 'var_mse', 'mean_mse'):=NULL][, .(mse = mean(mse), se = sd(mse)/sqrt(.N)),.(x, xi)]


ggplot(df_mse, aes(x=x, y=mse)) + geom_line(aes(color=factor(xi))) +
  xlim(0,12000) + ylim(0,0.02) + geom_ribbon(aes(ymin=mse-(1.96*se), ymax=mse+(1.96*se), group=xi), alpha=0.4,  fill="grey70") +
  geom_dl(aes(label=xi), method=list('last.points', cex=0.8)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'MSE of Mean') + ggsave("wise_mn.png", dpi=400, height = 5, width=10, scale = 0.8)



df_mse <- copy(main_xi_df)[, mse := var_mse][, c('regret', 'var_mse', 'mean_mse'):=NULL][, .(mse = mean(mse), se = sd(mse)/sqrt(.N)),.(x, xi)]


ggplot(df_mse, aes(x=x, y=mse)) + geom_line(aes(color=factor(xi))) +
  xlim(0,12000) + ylim(0,0.02) + geom_ribbon(aes(ymin=mse-(1.96*se), ymax=mse+(1.96*se), group=xi), alpha=0.4,  fill="grey70") +
  geom_dl(aes(label=xi), method=list('last.points', cex=0.8)) + theme_minimal() + 
  theme(legend.position = "none") + 
  labs(x='Time Period', y = 'MSE of Variance') + ggsave("wise_var.png", dpi=400, height = 5, width=10, scale = 0.8)



```









# Regret Order Analysis

```{r echo=FALSE, cache=FALSE, warning=FALSE, eval=reg_order_analysis}


setwd("G:\\My Drive\\Research\\Bandits\\code\\bandits\\analysis\\output")


data <- fread("wise_regret_analysis_100.csv") 

data <- data[, alg := ifelse(alg=="ab", "ABTesting", ifelse(alg=="thomp","THOMP", ifelse(alg=="thomp_inf", "THOMP_INF", NA)))]
group_outcome <- data[, x:= seq_len(.N),.(ite,alg)][, .(alg, regret, x)][,regret:=mean(regret),.(alg, x)]
group_outcome_thomp <- group_outcome[alg=='THOMP']
group_outcome_thompinf <- group_outcome[alg=='THOMP_INF']


logest <- lm(log(regret)~log(x),data=group_outcome_thompinf)
summary(logest)


logest <- lm(log(regret)~log(x),data=group_outcome_thomp)
summary(logest)


plot(log(group_outcome_thompinf$x), log(group_outcome_thompinf$regret))
plot(log(group_outcome_thompinf$x), (group_outcome_thompinf$regret))
plot(log(group_outcome_thomp$x), group_outcome_thomp$regret)
plot(log(group_outcome_thomp$x), log(group_outcome_thomp$regret))


```





# Bias Analysis


## Weighing algorithms

Weighing algorithms like IPW (Inverse propensity weighed) and AIPW (Augmented Inverse propensity weighed) correct for this bias by inversely weighing the outcome estimate with propensity of picking the arm.

We now empirically check whether Bias is 0 for these estimates



### Bias and Variance of the Best arm

```{r echo=FALSE, cache=FALSE, warning=FALSE}

# Bias of the Best arm


best <- agg_data[group==which.max(true_means)-1][,bias := mn-max(true_means)][, .(Bias = mean(bias), se = sd(bias)/sqrt(.N)),.(alg)]

ylimit <- max(abs(c(best$Bias + qnorm(0.975)*best$se, best$Bias - qnorm(0.975)*best$se)))
ylimit <- 1.5*ylimit

ggplot(best, aes(x=reorder(alg, abs(Bias)), y=Bias)) + geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=Bias-qnorm(0.975)*se, ymax=Bias+qnorm(0.975)*se), width=0.2) +
  theme_bw()  + ylim(-ylimit, ylimit) + theme(axis.title.x=element_blank()) +
  geom_hline(yintercept = 0) + labs(title = "Bias of best arm") +
  theme(axis.text.x = element_text(angle = 90)) 


best <- agg_data[group==which.max(true_means)-1][,bias := mn-max(true_means)][, .(var = var(mn)),.(alg)]
 

ylimit <- max(best$var)
ylimit <- 1.5*ylimit

ggplot(best, aes(x=reorder(alg, abs(var)), y=var)) + geom_bar(stat="identity") +
  theme_bw()  + ylim(-ylimit, ylimit) + theme(axis.title.x=element_blank()) +
  geom_hline(yintercept = 0) + labs(title = "Var of best arm") +
  theme(axis.text.x = element_text(angle = 90)) 

```



### Bias and variance of the Worst arm

```{r echo=FALSE, cache=FALSE, warning=FALSE}
# Bias of the Best arm

worst <- agg_data[group==which.min(true_means)-1][,bias := mn-min(true_means)][, .(Bias = mean(bias), se = sd(bias)/sqrt(.N)),.(alg)]
#[alg %in% c('ab', 'thomp', 'thom_inf', 'thomp_eval_aipw', 'thomp_inf_eval_aipw')]

ylimit <- max(abs(c(worst$Bias + qnorm(0.975)*worst$se, worst$Bias - qnorm(0.975)*worst$se)))
ylimit <- 1.5*ylimit

ggplot(worst, aes(x=reorder(alg, abs(Bias)), y=Bias)) + geom_bar(stat="identity") +
  geom_errorbar(aes(ymin=Bias-qnorm(0.975)*se, ymax=Bias+qnorm(0.975)*se), width=0.2) +
  theme_bw()  + ylim(-ylimit, ylimit) + theme(axis.title.x=element_blank()) +
  geom_hline(yintercept = 0) + labs(title = "Bias of worst arm") +
  theme(axis.text.x = element_text(angle = 90)) 


worst <- agg_data[group==which.min(true_means)-1][,bias := mn-min(true_means)][, .(var = var(mn)),.(alg)]
#[alg %in% c('ab', 'thomp', 'thom_inf', 'thomp_eval_aipw', 'thomp_inf_eval_aipw')]
 

ylimit <- max(worst$var)
ylimit <- 1.5*ylimit

ggplot(worst, aes(x=reorder(alg, abs(var)), y=var)) + geom_bar(stat="identity") +
  theme_bw()  + ylim(-ylimit, ylimit) + theme(axis.title.x=element_blank()) +
  geom_hline(yintercept = 0) + labs(title = "Var of worst arm") +
  theme(axis.text.x = element_text(angle = 90))


```





# Hypothesis Testing
```{r echo=FALSE, cache=FALSE, warning=FALSE, eval=group_allocations}


setwd("G:\\My Drive\\Research\\Bandits\\code\\bandits\\analysis\\output")
hyp_data <- copy(agg_data)

#true_means <- c(0.37098621, 0.33080171, 0.1699615 , 0.18902466, 0.6743146)


data_0 <- hyp_data[group==0] 
data_1 <- hyp_data[group==1]
# 
# a <- data_0[data_0$alg=='thomp_bern_eval_aipw_var', 'var_est']
# data_0[data_0$alg=='thomp_bern_eval_aipw', 'var_est'] = a
# 
# a <- data_0[data_0$alg=='thomp_bern_inf_eval_aipw_var', 'var_est']
# data_0[data_0$alg=='thomp_bern_inf_eval_aipw', 'var_est'] = a
# 
# a <- data_1[data_1$alg=='thomp_bern_eval_aipw_var', 'var_est']
# data_1[data_1$alg=='thomp_bern_eval_aipw', 'var_est'] = a
# 
# a <- data_1[data_1$alg=='thomp_bern_inf_eval_aipw_var', 'var_est']
# data_1[data_1$alg=='thomp_bern_inf_eval_aipw', 'var_est'] = a
# 
# a <- data_0[data_0$alg=='thomp_bern_batched_eval_aipw_var', 'var_est']
# data_0[data_0$alg=='thomp_bern_batched_eval_aipw', 'var_est'] = a
# 
# a <- data_0[data_0$alg=='thomp_bern_batched_inf_eval_aipw_var', 'var_est']
# data_0[data_0$alg=='thomp_bern_batched_inf_eval_aipw', 'var_est'] = a
# 
# a <- data_1[data_1$alg=='thomp_bern_batched_eval_aipw_var', 'var_est']
# data_1[data_1$alg=='thomp_bern_batched_eval_aipw', 'var_est'] = a
# 
# a <- data_1[data_1$alg=='thomp_bern_batched_inf_eval_aipw_var', 'var_est']
# data_1[data_1$alg=='thomp_bern_batched_inf_eval_aipw', 'var_est'] = a


merged_data <- merge(data_0, data_1, by=c('ite','alg'))
merged_data <- merged_data[, ':='(m1 = mean_est.x, m2=mean_est.y, n1=arm_pull_tracker.x, n2=arm_pull_tracker.y)]

hyp_z <- merged_data[, pooled_m := ((m2*n2) + (m1*n1))/(n2+n1)][,zval := (m2-m1)/sqrt(pooled_m*(1-pooled_m)*((1/n2)+(1/n1)))][,pval := 2*pnorm(-abs(zval))][,test_pass := ifelse(pval<0.05, TRUE, FALSE)]

# 
# hyp <- merged_data[,`:=`(tval = (mean_est.y-mean_est.x)/(sqrt((var_est.x/arm_pull_tracker.x)+(var_est.y/arm_pull_tracker.y))), df = arm_pull_tracker.x+arm_pull_tracker.y-2)][,pval := dt(tval, df)][,test_pass := ifelse(pval<0.05, TRUE, FALSE)]
# 


final_results <- hyp_z[!grepl("var", alg)][,tot := .N,.(alg)][,.(cnt = .N, perc = .N/128),.(alg, test_pass)] 



```




# Consistency of estimator



# Normality of estimator

We Expect 

* AB Testing - Best - Normal
* AB Testing - Worst - Normal


* Thompson Sampling - Best - Normal
* Thompson Sampling - Worst - Not Normal


## AB Testing

```{r echo=FALSE, warning=FALSE}

best_ab <- copy(agg_data)[group==which.max(true_means)-1 & alg=='ab_bern']

plotNormalHistogram(best_ab$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - AB")
abline(v=3,  col="red")

shapiro.test(best_ab$mn)

worst_ab <- copy(agg_data)[group==which.min(true_means)-1 & alg=='ab_bern']

plotNormalHistogram(worst_ab$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - AB",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_ab$mn)


```

## Thompson Sampling

```{r echo=FALSE, warning=FALSE}

best_thomp <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_bern']

plotNormalHistogram(best_thomp$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMP")
abline(v=2,  col="red")

shapiro.test(best_thomp$mn)

worst_thomp <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_bern']

plotNormalHistogram(worst_thomp$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMP",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=1,  col="red")

shapiro.test(worst_thomp$mn)
```

```{r echo=FALSE, warning=FALSE}

best_thomp_ipw <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_ipw']

plotNormalHistogram(best_thomp_ipw$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMPIPW")

abline(v=3,  col="red")

shapiro.test(best_thomp_ipw$mn)

worst_thomp_ipw <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_ipw']

plotNormalHistogram(worst_thomp_ipw$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMPIPW",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_thomp_ipw$mn)
```

```{r echo=FALSE, warning=FALSE}

best_thomp_eval_aipw <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_bern_eval_aipw']

plotNormalHistogram(best_thomp_eval_aipw$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMP_EVAL")
abline(v=3,  col="red")

shapiro.test(best_thomp_eval_aipw$mn)

worst_thomp_eval_aipw <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_bern_eval_aipw']

plotNormalHistogram(worst_thomp_eval_aipw$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMP_EVAL",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 100)

abline(v=2,  col="red")

shapiro.test(worst_thomp_eval_aipw$mn)
```


## Thompson Sampling INF

```{r echo=FALSE, warning=FALSE}

best_thomp_inf <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_inf_bern']

plotNormalHistogram(best_thomp_inf$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMPINF")
abline(v=3,  col="red")

shapiro.test(best_thomp_inf$mn)

worst_thomp_inf <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_inf_bern']

plotNormalHistogram(worst_thomp_inf$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMPINF",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=1,  col="red")

shapiro.test(worst_thomp_inf$mn)
```

```{r echo=FALSE, warning=FALSE}

best_thomp_inf_ipw <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_inf_ipw']

plotNormalHistogram(best_thomp_inf_ipw$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMPINFIPW")
abline(v=3,  col="red")

shapiro.test(best_thomp_inf_ipw$mn)

worst_thomp_inf_ipw <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_inf_ipw']

plotNormalHistogram(worst_thomp_inf_ipw$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMPINFIPW",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=2,  col="red")

shapiro.test(worst_thomp_inf_ipw$mn)
```

```{r echo=FALSE, warning=FALSE}

best_thomp_inf_eval_aipw <- copy(agg_data)[group==which.max(true_means)-1 & alg=='thomp_inf_bern_eval_aipw']

plotNormalHistogram(best_thomp_inf_eval_aipw$mn, prob = TRUE, col = "gray",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50,
                    main = "Mean estimates of Best Arm - THOMPINFEVAL")
abline(v=3,  col="red")

shapiro.test(best_thomp_inf_eval_aipw$mn)

worst_thomp_inf_eval_aipw <- copy(agg_data)[group==which.min(true_means)-1 & alg=='thomp_inf_bern_eval_aipw']

plotNormalHistogram(worst_thomp_inf_eval_aipw$mn, prob = TRUE, col = "gray", main = "Mean estimates of Worst Arm - THOMPINFEVAL",
                    linecol = "blue", lwd = 2, length = 1000, breaks= 50)

abline(v=1,  col="red")

shapiro.test(worst_thomp_inf_eval_aipw$mn)

```